<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Arduino Messaging</title>
</head>

<body>
<h1>Arduino Gateway messaging</h1>
<h5>Version 3.6 Alpha; Message format may (and will) change between LamPI releases</h5>
<h2>Intro</h2>
<p>When using the Arduino as a gateway for 433MHz messages, the Raspberry will loose a lot of cpu/interrupt intensive workload which is taken over by the Arduino. The Raspberry will then send simple and short messages to the arduino, for example to switch on the lights and the Arduino will message the Raspberry upon receiving sensor values or&nbsp;handset commands from 433 MHz devices.</p>
<p>&nbsp;</p>
<h2>Message format</h2>
<p>Initially, we will focus on the klikaanklikuit commands as those are the devices I do have in my home. We like to include some other protocols as well, so that the direct connected devices to the Raspberry and those supported by the Arduino gateway become the same. </p>
<p>This will mean in short that we like to include support for weather sensors etc.</p>
<p>Of course we have to keep in mind that the Arduino received, which is interrupt based, will spend mroe time in recognizing incoming pulses if we include a great deal of protocols in the Arduino. Therefore it is wise that the Arduino will only selectively receive messages and non important message format of devices not used will be excluded from its parser.</p>
<p>Keep in mind thta we keep the message layout VERY SIMPLE, initially we supported a set which was more verbose, however this would mean a lot more work on the Arduino side to understand the messages, interpret and send responses.&nbsp;The current message format is so simple that almost every command and parameter will fit in a char, except group codes etc. which will be interger in length.</p>
<p>* Message&nbsp;formats not supported but planned are put in the table with a *</p>
<p>&nbsp;</p>
<h3>Initiated by the Raspberry</h3>
<table width="1125" height="115" border="1">
  <tr>
    <th width="156" scope="col"><h2>Command</h2></th>
    <th width="14" scope="col"><h2>&nbsp;</h2></th>
    <th width="399" scope="col"><h2>Send</h2></th>
    <th width="528" scope="col"><h2>Notes</h2></th>
  </tr>
  <tr>
    <td><strong>Admin commands</strong></td>
    <td>&nbsp;</td>
    <td><strong>&gt; {cnt} 0 {cmd} {Args} {Args}</strong></td>
    <td>A series of commands</td>
  </tr>
  <tr>
    <td>List active codecs</td>
    <td>&nbsp;</td>
    <td>&gt; {cnt} 0 0 {list of codecs for devices/sensors}</td>
    <td>First byte is admin mode; Second byte is code select command; rest of list is codecs (integers) to support when receiving.<br />
      <br />
      Result is binary string, 0 is off, 1 is on</td>
  </tr>
  <tr>
    <td>Set Codec enable</td>
    <td>*</td>
    <td>&gt; {cnt} 0 1 {codec} {value}</td>
    <td>Same as above, but set a value on (=1) or off (=0)</td>
  </tr>
  <tr>
    <td>Set  statistics</td>
    <td>*</td>
    <td>&gt; {cnt} 0 2 {value}</td>
    <td>Ask for statistics, expect a comment back!! Values 0=off and 1 is on</td>
  </tr>
  <tr>
    <td>Set debug level</td>
    <td>&nbsp;</td>
    <td>&gt; {cnt} 0 3 {value}</td>
    <td>Values 0 and 1 are supported (2 and 3 optional)</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td><strong>Transmit Commands</strong></td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>Send to transmitter</td>
    <td>&nbsp;</td>
    <td>&gt; {cnt} 1 {codec} {group}  {unit} {value}</td>
    <td>First byte is &quot;send&quot; mode; second byte codec. Codec: 0 for Kaku, 1 for Action (see database.cfg for brands).<br />
    &gt; 100 1 0 100 1 10 ; Sets device with group 100, unit 1 to 10</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>*</td>
    <td>&gt; {cnt} 2 {Message to Sensor}</td>
    <td>Not used</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
</table>
<p>The first &quot;word&quot; is the message counter that should be in every message. The second gives the command for the Arduino, The next byte is a subcommand e.g. all admin commands or all transmitter commands etc. The rest of the string are bytes to support these subcommands.</p>
<p>&nbsp;</p>
<h2>Initiated by the Arduino</h2>
<p>Messages generated and sent by the arduino are short and simple and are either a reply (for command above) to a Raspberry request or are coming from 433MHz messages received over its antenna. </p>
<table width="1126" height="115" border="1">
  <tr>
    <th width="246" scope="col">Command</th>
    <th width="8" scope="col">&nbsp;</th>
    <th width="412" scope="col">Receive</th>
    <th width="432" scope="col">Notes</th>
  </tr>
  <tr>
    <td>All other comments or messages coming from Arduino</td>
    <td>&nbsp;</td>
    <td>! {Message}</td>
    <td>Everythig after the ! is just comment and not interpreted</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td><strong>Reply to an admin message</strong></td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>*</td>
    <td>&lt; {cnt} 0 0 {list of devices codecs}</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&lt; {cnt} 0 1 {codec} {value of  codec}</td>
    <td>value must be 0 or 1</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&lt; {cnt} 0 2 {List of statistics}</td>
    <td>NOTE: exceptional, expect a ! list of comments back</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&lt; {cnt} 0 3 {debug reply}</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td><strong>Reply to a device message of Raspi</strong></td>
    <td>&nbsp;</td>
    <td>&lt; {cnt} 1 {codec} {group} {unit} {value}</td>
    <td><p>This is a reply on a Raspberry message (optional: hardly used).</p></td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&lt; {cnt} </td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td><strong>Receive device  message</strong></td>
    <td>&nbsp;</td>
    <td>&lt; {cnt} 2 {codec} {group} {unit} {value}</td>
    <td>Value is &quot;off&quot;, &quot;on&quot; and 0-15 as a dim value</td>
  </tr>
  <tr>
    <td><blockquote>
      <p>Kaku message</p>
    </blockquote></td>
    <td>&nbsp;</td>
    <td>&lt; {cnt} 2 0 100 1 0</td>
    <td>kaku switch with group 100 and unit 1 is set to off</td>
  </tr>
  <tr>
    <td><blockquote>
      <p>Action message</p>
    </blockquote></td>
    <td>&nbsp;</td>
    <td>&lt; {cnt} 2 1 31 2 1</td>
    <td>action switch group 31, unit 2 is set on</td>
  </tr>
  <tr>
    <td><blockquote>
      <p>Livolo message</p>
    </blockquote></td>
    <td>&nbsp;</td>
    <td>&lt; {cnt} 2 5 23783 8 1</td>
    <td>Level not used but for compatibility with other codecs is always 1</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td>Receive a 433 Sensor message</td>
    <td>&nbsp;</td>
    <td>&lt; {cnt} 3 {codec} {address} {channel} {temperature} {humidity}</td>
    <td>wt440h (UPM/Esic) is one codec 0 but there are more</td>
  </tr>
  <tr>
    <td><blockquote>
      <p>onboard Sensor</p>
    </blockquote></td>
    <td>&nbsp;</td>
    <td>&lt; {cnt} 3 0 40 0 26.5 50.1</td>
    <td>Arduino on-board I2C sensor message. The code 40 tells us it is a HTU21 SHT21 device on the I2C bus</td>
  </tr>
  <tr>
    <td><blockquote>
      <p>example:</p>
    </blockquote></td>
    <td>&nbsp;</td>
    <td>&lt; {cnt} 3 1 1 0 8984 85</td>
    <td>Receive UPM weather message temp (20.1 Celcius encoded) and humi (85%)</td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
</table>
<p>As you can see, the message coming in from the Arduino of a device is the same as the message that is sent by the Raspberry to get the Arduino to send a command to a KlikAanKlikAuit device.</p>
<p>&nbsp;</p>
<h2>Codecs</h2>
<p>The codec is different for different commands. So the codec for handsets and sensors is different.</p>
<h3>Handsets</h3>
<p>Please keep in mind that for the current version not all protocols are supported. Legend: &lt; means receive, &gt; means transmit is supported</p>
<ul>
  <li>0 kaku (&lt; &gt;), klikaanklikuit new remotes</li>
  <li>1 action (&lt;&gt;)</li>
  <li>2 Blokker (&lt;), not tested</li>
  <li>3 Klikaanklikuit old version (&lt;), not tested</li>
  <li>4 Elro (&lt;), not tested</li>
  <li>5 Livolo (&lt;&gt;), Livolo switches are supported by the receiver</li>
  <li>6 Kopou (&lt;), many will be received as many are sent by the transmitter ( :-) )</li>
</ul>
<h3>Sensors</h3>
<p>Some sensors may have their own manufacturer protocol and their own transmitter. But there may also be ones that are connected to an Arduino who will forward the sensor message to the LamPI-node daemon.</p>
<ul>
  <li>0: Reserved for on-board sensors of the Arduino (such as the HTU21D temperature and humidity sensor).</li>
  <li>1: wt440h (&lt;); UPM (or Esic) weather sensor. Range of reception not so good. The address is 1 to 15, and the Channel is </li>
</ul>
<h3>Blinds, Curtains, Motors</h3>
<p>Not supprted and tested yet </p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><br />
</p>
</body>
</html>
